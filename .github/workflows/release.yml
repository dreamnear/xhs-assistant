name: Release Application

# è§¦å‘æ¡ä»¶ï¼šåˆ›å»º tag æˆ– release
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰
  release:
    types: [created]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é˜²æ­¢ OOM é”™è¯¯
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build-and-release:
    name: Build on ${{ matrix.os }}
    strategy:
      # å•ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      fail-fast: false
      matrix:
        include:
          # Windows æž„å»º
          - os: windows-latest
            name: 'Windows'
            platform: 'windows/amd64'
            spec_file: 'build/windows.spec'
            output_name: 'å°çº¢ä¹¦æ•°æ®æŠ“å–å·¥å…·.exe'
            asset_name: 'xhs-assistant-windows-v${{ github.ref_name }}.exe'
            asset_content_type: 'application/vnd.microsoft.portable-executable'

          # macOS æž„å»º
          - os: macos-latest
            name: 'macOS'
            platform: 'darwin/amd64'
            spec_file: 'build/build_onefile.spec'
            output_name: 'å°çº¢ä¹¦æ•°æ®æŠ“å–å·¥å…·'
            asset_name: 'xhs-assistant-macos-v${{ github.ref_name }}'
            asset_content_type: 'application/octet-stream'

          # Linux æž„å»º
          - os: ubuntu-latest
            name: 'Linux'
            platform: 'linux/amd64'
            spec_file: 'build/build_onefile.spec'
            output_name: 'xhs-assistant'
            asset_name: 'xhs-assistant-linux-v${{ github.ref_name }}'
            asset_content_type: 'application/octet-stream'

    runs-on: ${{ matrix.os }}

    # ä¸º Release åˆ›å»ºéœ€è¦æƒé™
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. å®‰è£… PyInstaller
      - name: Install PyInstaller
        run: |
          pip install pyinstaller==6.11.0

      # 5. ä½¿ç”¨ PyInstaller æ‰“åŒ…
      - name: Build with PyInstaller
        run: |
          pyinstaller ${{ matrix.spec_file }} --clean
        shell: bash

      # 6. é‡å‘½åè¾“å‡ºæ–‡ä»¶
      - name: Rename executable
        run: |
          # èŽ·å–ç‰ˆæœ¬å·
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}  # ç§»é™¤ v å‰ç¼€

          # é‡å‘½åæ–‡ä»¶
          if [ "${{ runner.os }}" == "Windows" ]; then
            mv "dist/${{ matrix.output_name }}" "dist/xhs-assistant-windows-${VERSION}.exe" || echo "File not found"
          elif [ "${{ runner.os }}" == "macOS" ]; then
            mv "dist/${{ matrix.output_name }}" "dist/xhs-assistant-macos-${VERSION}" || echo "File not found"
          else
            mv "dist/${{ matrix.output_name }}" "dist/xhs-assistant-linux-${VERSION}" || echo "File not found"
          fi
        shell: bash
        continue-on-error: true

      # 7. æŸ¥æ‰¾æž„å»ºäº§ç‰©
      - name: Find build artifacts
        id: find_artifacts
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}

          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "artifact_path=dist/xhs-assistant-windows-${VERSION}.exe" >> $GITHUB_OUTPUT
          elif [ "${{ runner.os }}" == "macOS" ]; then
            echo "artifact_path=dist/xhs-assistant-macos-${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "artifact_path=dist/xhs-assistant-linux-${VERSION}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 8. ä¸Šä¼ åˆ° GitHub Releases
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_artifacts.outputs.artifact_path }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. æ˜¾ç¤ºæž„å»ºä¿¡æ¯
      - name: Build summary
        run: |
          VERSION="${{ github.ref_name }}"

          echo "### âœ… å‘å¸ƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°**: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ“ä½œç³»ç»Ÿ**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° [GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # å‘å¸ƒåŽåˆ›å»ºé€šçŸ¥
  release-summary:
    name: Release Summary
    needs: build-and-release
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write

    steps:
      - name: Create release summary
        run: |
          VERSION="${{ github.ref_name }}"

          echo "### ðŸŽ‰ ç‰ˆæœ¬ ${VERSION} å‘å¸ƒå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ ä¸‹è½½åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[GitHub Releases é¡µé¢](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“‹ åŒ…å«æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`xhs-assistant-windows-${VERSION}.exe\` - Windows å¯æ‰§è¡Œæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- \`xhs-assistant-macos-${VERSION}\` - macOS å¯æ‰§è¡Œæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- \`xhs-assistant-linux-${VERSION}\` - Linux å¯æ‰§è¡Œæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
