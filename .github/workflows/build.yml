name: Build Application

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é˜²æ­¢ OOM é”™è¯¯
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    strategy:
      # å•ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      fail-fast: false
      matrix:
        include:
          # Windows æž„å»º
          - os: windows-latest
            name: 'Windows'
            platform: 'windows/amd64'
            spec_file: 'build/windows.spec'
            output_name: 'å°çº¢ä¹¦æ•°æ®æŠ“å–å·¥å…·.exe'
            artifact_name: 'xhs-assistant-windows.exe'

          # macOS Intel æž„å»º
          - os: macos-13
            name: 'macOS Intel'
            platform: 'darwin/x86_64'
            spec_file: 'build/build_onefile.spec'
            output_name: 'å°çº¢ä¹¦æ•°æ®æŠ“å–å·¥å…·'
            artifact_name: 'xhs-assistant-macos-intel'

          # macOS Apple Silicon æž„å»º
          - os: macos-14
            name: 'macOS Apple Silicon'
            platform: 'darwin/arm64'
            spec_file: 'build/build_onefile.spec'
            output_name: 'å°çº¢ä¹¦æ•°æ®æŠ“å–å·¥å…·'
            artifact_name: 'xhs-assistant-macos-arm64'

          # Linux æž„å»º
          - os: ubuntu-latest
            name: 'Linux'
            platform: 'linux/amd64'
            spec_file: 'build/build_onefile.spec'
            output_name: 'xhs-assistant'
            artifact_name: 'xhs-assistant-linux'

    runs-on: ${{ matrix.os }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. å®‰è£… PyInstaller
      - name: Install PyInstaller
        run: |
          pip install pyinstaller==6.11.0

      # 5. å®‰è£… Playwright æµè§ˆå™¨ï¼ˆå¯é€‰ï¼Œæž„å»ºæ—¶ä¸éœ€è¦ï¼Œè¿è¡Œæ—¶éœ€è¦ï¼‰
      - name: Install Playwright
        run: |
          playwright install chromium
        continue-on-error: true  # æž„å»ºçŽ¯å¢ƒä¸­å®‰è£…å¤±è´¥ä¸å½±å“æ‰“åŒ…

      # 6. ä½¿ç”¨ PyInstaller æ‰“åŒ…
      - name: Build with PyInstaller
        run: |
          pyinstaller ${{ matrix.spec_file }} --clean
        shell: bash

      # 7. æŸ¥æ‰¾ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
      - name: Find executable
        id: find_exe
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "exe_path=dist/$(ls dist/*.exe | head -n1 | xargs basename)" >> $GITHUB_OUTPUT
          elif [ "${{ runner.os }}" == "macOS" ]; then
            echo "exe_path=dist/$(ls dist/ | head -n1)" >> $GITHUB_OUTPUT
          else
            echo "exe_path=dist/$(ls dist/ | head -n1)" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 8. é‡å‘½åè¾“å‡ºæ–‡ä»¶
      - name: Rename executable
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            mv "dist/${{ matrix.output_name }}" "dist/${{ matrix.artifact_name }}" || echo "File not found, skipping rename"
          else
            mv "dist/${{ matrix.output_name }}" "dist/${{ matrix.artifact_name }}" || echo "File not found, skipping rename"
          fi
        shell: bash
        continue-on-error: true

      # 9. ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/${{ matrix.artifact_name }}
            dist/${{ matrix.output_name }}
          retention-days: 30
          if-no-files-found: warn

      # 10. æ˜¾ç¤ºæž„å»ºä¿¡æ¯
      - name: Build summary
        run: |
          echo "### æž„å»ºå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°**: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ“ä½œç³»ç»Ÿ**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python ç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° Artifacts" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # æ±‡æ€»æ‰€æœ‰æž„å»ºçŠ¶æ€
  build-summary:
    name: Build Summary
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "### ðŸŽ‰ æž„å»ºæµç¨‹å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šæ–¹å„å¹³å°çš„æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¸‹è½½æž„å»ºäº§ç‰©ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. è¿›å…¥æœ¬æ¬¡ Actions è¿è¡Œé¡µé¢" >> $GITHUB_STEP_SUMMARY
          echo "2. æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨çš„ \"Artifacts\" åŒºåŸŸ" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
